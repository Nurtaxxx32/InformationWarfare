<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="appTitle">Dahook IT Powered IW Tactical Analyst</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617;
            color: #e2e8f0;
            background-image: radial-gradient(circle at top right, rgba(14, 165, 233, 0.15), transparent 40%),
                              radial-gradient(circle at bottom left, rgba(14, 165, 233, 0.15), transparent 40%);
            /* Add background animation */
            animation: animateBackground 20s ease-in-out infinite;
        }

        /* Keyframes for background animation */
        @keyframes animateBackground {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        #chat-container::-webkit-scrollbar { width: 8px; }
        #chat-container::-webkit-scrollbar-track { background: transparent; }
        #chat-container::-webkit-scrollbar-thumb { background-color: #334155; border-radius: 20px; }
        .font-mono { font-family: 'Roboto Mono', monospace; }
        .bot-message-gradient { background-color: rgba(30, 41, 59, 0.5); border: 1px solid #475569; }
        .user-message-gradient { background: linear-gradient(145deg, #0ea5e9, #0284c7); }
        
        /* General Fade-in Animation */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .chat-message { animation: fadeIn 0.4s ease-out; }

        /* Pulsing Glow Animation */
        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 15px rgba(14, 165, 233, 0.4); }
            50% { box-shadow: 0 0 25px rgba(14, 165, 233, 0.7); }
        }
        @keyframes pulseText {
            0%, 100% { text-shadow: 0 0 4px rgba(14, 165, 233, 0.5); }
            50% { text-shadow: 0 0 8px rgba(14, 165, 233, 0.9); }
        }

        .feature-button { transition: all 0.3s ease-in-out; border-width: 1px; border-color: #475569; background-color: rgba(30, 41, 59, 0.5); }
        .feature-button:hover { 
            border-color: #94a3b8; 
            background-color: rgba(51, 65, 85, 0.7); 
            transform: translateY(-2px) scale(1.03);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        .feature-button.active { 
            background-color: #0ea5e9; 
            color: #ffffff; 
            border-color: #0ea5e9; 
            animation: pulseGlow 3s infinite;
        }

        .output-style-button { transition: all 0.3s ease-in-out; border: 1px solid #475569; background-color: transparent; color: #94a3b8; }
        .output-style-button:hover { background-color: rgba(51, 65, 85, 0.7); border-color: #94a3b8; transform: scale(1.05); }
        .output-style-button.active { color: #e2e8f0; background-color: #334155; border-color: #64748b; }
        
        .action-button { transition: all 0.3s ease-in-out; background-color: #334155; border: 1px solid #64748b; }
        .action-button:hover { 
            background-color: #475569; 
            border-color: #94a3b8; 
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 0 15px rgba(14, 165, 233, 0.3);
        }

        .glass-ui { 
            background-color: rgba(15, 23, 42, 0.6); 
            backdrop-filter: blur(12px); 
            -webkit-backdrop-filter: blur(12px); 
            border: 1px solid rgba(51, 65, 85, 0.5); 
        }

        .prose-custom { font-size: 0.9rem; }
        .prose-custom h3 { font-size: 1rem; font-weight: 700; color: #f0f9ff; margin-top: 1.25rem; margin-bottom: 0.25rem; }
        .prose-custom p { margin-top: 0.25rem; line-height: 1.5; }
        .prose-custom ul { margin-top: 0.5rem; margin-left: 0; list-style-type: none; padding-left: 0; }
        .prose-custom li { margin-top: 0.25rem; padding-left: 0; }
        .prose-custom strong { color: #7dd3fc; }
        #pin-overlay, #flowchart-modal { z-index: 100; }
        #userInput { resize: none; }
        .mermaid { background-color: transparent !important; }
        
        /* Interactive Flowchart Styles */
        #modal-flowchart-container .node { cursor: pointer; transition: transform 0.1s ease-out; }
        #modal-flowchart-container .node:hover { transform: scale(1.02); }
        #modal-flowchart-container .node.selected > rect,
        #modal-flowchart-container .node.selected > circle,
        #modal-flowchart-container .node.selected > polygon,
        #modal-flowchart-container .node.selected > path {
            stroke: #0ea5e9 !important;
            stroke-width: 4px !important;
        }
        #modal-explanation-container::-webkit-scrollbar { width: 6px; }
        #modal-explanation-container::-webkit-scrollbar-track { background: transparent; }
        #modal-explanation-container::-webkit-scrollbar-thumb { background-color: #475569; border-radius: 20px; }

        /* Header title animation */
        #headerTitle {
            animation: pulseText 4s infinite ease-in-out;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
</head>
<body class="flex flex-col h-screen">

    <!-- PIN Overlay -->
    <div id="pin-overlay" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center transition-opacity duration-300">
        <div class="glass-ui rounded-2xl shadow-2xl p-8 w-full max-w-sm text-center">
            <h2 class="text-xl font-bold text-sky-400 mb-2">Authentication Required</h2>
            <p class="text-slate-400 mb-6 text-sm">Enter security PIN to access the system.</p>
            <form id="pin-form">
                <input type="password" id="pinInput" class="w-full text-center bg-slate-800 border border-slate-700 rounded-lg py-3 px-5 focus:outline-none focus:ring-2 focus:ring-sky-500 text-slate-200 placeholder-slate-500 tracking-widest" placeholder="PIN">
                <p id="pinError" class="text-red-400 text-xs h-4 mt-2"></p>
                <button type="submit" class="w-full mt-4 bg-sky-600 hover:bg-sky-700 text-white font-bold rounded-lg py-3 transition-all">Authorize</button>
            </form>
        </div>
    </div>

    <!-- Flowchart Modal -->
    <div id="flowchart-modal" class="fixed inset-0 bg-slate-900/90 backdrop-blur-md hidden flex-col items-center justify-center p-4 sm:p-8">
        <div class="w-full max-w-7xl h-full flex flex-col glass-ui rounded-lg relative">
            <div class="flex-1 flex flex-col md:flex-row overflow-hidden">
                <!-- Flowchart Pane -->
                <div id="modal-flowchart-container" class="w-full md:w-2/3 h-1/2 md:h-full bg-slate-900/30 overflow-hidden relative border-b md:border-b-0 md:border-r border-slate-700">
                    <!-- Panzoom will target the SVG inside this -->
                </div>
                <!-- Explanation Pane -->
                <div id="modal-explanation-container" class="w-full md:w-1/3 h-1/2 md:h-full p-4 sm:p-6 overflow-y-auto">
                    <h3 id="explanation-title" class="text-lg font-bold text-sky-400 mb-3 border-b border-slate-700 pb-2">Node Explanation</h3>
                    <div id="explanation-content" class="text-slate-300 space-y-4 prose-custom">
                        <p class="text-slate-400">Click on a node in the flowchart to see its detailed explanation here.</p>
                    </div>
                </div>
            </div>
        </div>
        <button id="close-flowchart-modal" class="absolute top-2 right-2 sm:top-6 sm:right-10 text-white text-4xl font-bold hover:text-sky-400 transition-colors">&times;</button>
    </div>

    <header class="glass-ui border-b p-3 shadow-lg text-center shrink-0">
        <div class="flex justify-between items-center">
             <div class="w-16">
                 <button id="knowledge-base-btn" title="View Source Knowledge" class="action-button rounded-full h-9 w-9 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22a10 10 0 1 1 0-20 10 10 0 0 1 0 20Z"/><path d="M12 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10Z"/><path d="M12 13a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"/><path d="m18 12-2.39-1.38"/><path d="m6 12 2.39-1.38"/><path d="m12 6-1.38 2.39"/><path d="m12 18-1.38-2.39"/><path d="m19.39 18.62-2.39-1.38"/><path d="m4.61 6.38 2.39 1.38"/><path d="m19.39 6.38-1.38 2.39"/><path d="m4.61 18.62 1.38-2.39"/></svg>
                 </button>
             </div>
            <div class="text-center">
                <h1 id="headerTitle" class="text-lg font-black font-mono text-sky-400 tracking-wider flex items-center justify-center gap-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="M12 18a6 6 0 1 0 0-12"></path></svg>
                    IW TACTICAL ANALYST
                </h1>
                <p id="headerSubtitle" class="text-xs text-sky-400/60 font-semibold">Dahook IT powered</p>
            </div>
            <button id="langSwitcher" class="lang-switcher w-16 h-8 rounded-full flex items-center justify-center text-xs font-bold bg-slate-800/50 border-slate-700 hover:bg-slate-700/70">EN</button>
        </div>
    </header>

    <main id="chat-container" class="flex-1 p-4 overflow-y-auto space-y-6"></main>
    
    <div id="action-button-container" class="px-4 pb-2 text-center"></div>

    <footer class="glass-ui border-t p-3 shrink-0">
        <div class="flex items-center justify-center gap-2 mb-3">
            <button id="mindmapModeBtn" class="output-style-button rounded-full py-1 px-4 text-xs font-medium">Mind Map</button>
            <button id="descriptiveModeBtn" class="output-style-button active rounded-full py-1 px-4 text-xs font-medium">Descriptive</button>
            <button id="flowchartModeBtn" class="output-style-button rounded-full py-1 px-4 text-xs font-medium">Flowchart</button>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-5 gap-2 mb-3">
             <button id="analyzeMode" class="feature-button active flex items-center justify-center gap-2 flex-1 rounded-lg py-2 px-3 text-xs font-semibold">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"></path></svg>
                <span id="analyzeBtnText">Analyze</span>
            </button>
             <button id="influenceMode" class="feature-button flex items-center justify-center gap-2 flex-1 rounded-lg py-2 px-3 text-xs font-semibold">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                <span id="influenceBtnText">Influence</span>
            </button>
             <button id="simulateMode" class="feature-button flex items-center justify-center gap-2 flex-1 rounded-lg py-2 px-3 text-xs font-semibold">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 17.5 3 6V3h3l11.5 11.5"></path><path d="M13 19h6v-6"></path><path d="m15 15 6 6"></path></svg>
                <span id="simulateBtnText">Simulate</span>
            </button>
             <button id="threatIntelMode" class="feature-button flex items-center justify-center gap-2 flex-1 rounded-lg py-2 px-3 text-xs font-semibold">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 6H3"></path><path d="M21 12H3"></path><path d="M21 18H3"></path></svg>
                <span id="threatIntelBtnText">Threat Intel</span>
            </button>
            <button id="postAnalysisMode" class="feature-button flex items-center justify-center gap-2 flex-1 rounded-lg py-2 px-3 text-xs font-semibold">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-search-2"><path d="M4 22h14a2 2 0 0 0 2-2V7.5L14.5 2H6a2 2 0 0 0-2 2v4"></path><polyline points="14 2 14 8 20 8"></polyline><path d="M5 17a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"></path><path d="m9 21-1.6-1.6"></path></svg>
                <span id="postAnalysisBtnText">Post Analysis</span>
            </button>
        </div>
        <div class="flex items-center space-x-2">
            <textarea id="userInput" class="flex-1 bg-slate-800 border border-slate-700 rounded-xl py-2 px-4 focus:outline-none focus:ring-2 focus:ring-sky-500 text-slate-200 placeholder-slate-500 text-sm" rows="1" placeholder="e.g., How to conduct a memetic blitz"></textarea>
            <button id="sendButton" class="bg-sky-600 hover:bg-sky-700 text-white font-bold rounded-full h-10 w-10 flex items-center justify-center transition-transform transform hover:scale-110 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-900 focus:ring-sky-500 shrink-0">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
            </button>
        </div>
        <p class="text-xs text-center text-slate-500 mt-3" id="copyrightText">Copyright &copy; <span id="copyright-year"></span> Nurtaz Uddin Al Masuk. All Rights Reserved.</p>
    </footer>

    <script type="module">
        // Initialize global variables
        document.getElementById('copyright-year').textContent = new Date().getFullYear();
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const knowledgeBaseBtn = document.getElementById('knowledge-base-btn');
        const analyzeModeBtn = document.getElementById('analyzeMode');
        const influenceModeBtn = document.getElementById('influenceMode');
        const simulateModeBtn = document.getElementById('simulateMode');
        const threatIntelModeBtn = document.getElementById('threatIntelMode');
        const postAnalysisModeBtn = document.getElementById('postAnalysisMode');
        const actionButtonContainer = document.getElementById('action-button-container');
        const langSwitcher = document.getElementById('langSwitcher');
        const mindmapModeBtn = document.getElementById('mindmapModeBtn');
        const descriptiveModeBtn = document.getElementById('descriptiveModeBtn');
        const flowchartModeBtn = document.getElementById('flowchartModeBtn');
        const pinOverlay = document.getElementById('pin-overlay');
        const pinForm = document.getElementById('pin-form');
        const pinInput = document.getElementById('pinInput');
        const pinError = document.getElementById('pinError');
        const flowchartModal = document.getElementById('flowchart-modal');
        const modalFlowchartContainer = document.getElementById('modal-flowchart-container');
        const closeFlowchartModalBtn = document.getElementById('close-flowchart-modal');

        let chatHistory = [];
        let currentMode = 'analyze';
        let outputStyle = 'descriptive';
        let currentLanguage = 'en';
        let wargameState = { phase: 'idle', turns: 0, startIndex: -1 };
        let panzoomInstance = null;
        let activeFlowchartNodeId = null;

        // Language and UI configuration
        const languageStrings = {
            en: {
                appTitle: "Dahook IT Powered IW Tactical Analyst",
                headerTitle: "IW TACTICAL ANALYST",
                headerSubtitle: "Dahook IT powered",
                analyzeBtnText: "Analyze",
                influenceBtnText: "Influence",
                simulateBtnText: "Simulate",
                threatIntelBtnText: "Threat Intel",
                postAnalysisBtnText: "Post Analysis",
                copyrightText: "Copyright &copy; {year} Nurtaz Uddin Al Masuk. All Rights Reserved.",
                placeholders: {
                    analyze: "e.g., How to conduct a memetic blitz",
                    influence: "e.g., Target: Gamers, Goal: Promote cyber hygiene",
                    simulate: "e.g., A corporate merger scenario",
                    threat_intel: "e.g., Disinformation in the South China Sea",
                    post_analysis: "Paste the full text of the social media post to analyze..."
                },
                tutorial: [
                    "Welcome to the **IW Tactical Analyst**. I am a synthetic intelligence designed to help you navigate the complex world of Information Warfare.",
                    "You can now select an output style: **Mind Map** for structured overviews, **Descriptive** for detailed paragraphs, or **Flowchart** for visualizing processes. Choose your preferred format below.",
                    "You can interact with me using five distinct modes. Select a mode below to begin:",
                    "**Analyze Mode** 🔎\n- Explain any IW tactic, model, or concept. You can now ask 'how to' questions for step-by-step guides.",
                    "**Influence Mode** 👥\n- Provide a target audience and a strategic goal, and I will design a detailed influence campaign for you.",
                    "**Simulate Mode** ⚔️\n- Describe a conflict scenario. I will act as the 'Red Team' to launch an attack. You will be the 'Blue Team' and must decide how to respond.",
                    "**Threat Intel Mode** 🌐\n- Ask about a current event or topic, and I will provide a threat briefing based on open-source intelligence.",
                    "**Post Analysis Mode** 📄\n- Paste the text from a social media post. I will first dissect it to reveal the propaganda techniques being used, then provide tactical recommendations for enhancement, and finally, deliver a step-by-step blueprint to make the message go viral.",
                    "I'm ready for your query. Please select a mode and enter your first command."
                ],
                welcomeBack: "System re-activated. I am the **IW Tactical Analyst**. Please select a mode and issue your query.",
                reportRequest: "Requesting Post-Action Report...",
                reportBtnText: "✨ Request Post-Action Report",
                autoScenario: "Requesting auto-generated scenario...",
                blueTeamPlaceholder: "Describe your Blue Team action...",
                viewFullscreen: "Fullscreen"
            },
            bn: {
                appTitle: "ডাহুক আইটি চালিত আইডব্লিউ কৌশলগত বিশ্লেষক",
                headerTitle: "আইডব্লিউ কৌশলগত বিশ্লেষক",
                headerSubtitle: "ডাহুক আইটি চালিত",
                analyzeBtnText: "বিশ্লেষণ",
                influenceBtnText: "প্রভাব",
                simulateBtnText: "সিমুলেশন",
                threatIntelBtnText: "থ্রেট ইন্টেল",
                postAnalysisBtnText: "পোস্ট বিশ্লেষণ",
                copyrightText: "কপিরাইট &copy; {year} নুরতাজ উদ্দিন মাসুক। সর্বস্বত্ব সংরক্ষিত।",
                placeholders: {
                    analyze: "যেমন, কিভাবে একটি মেমেটিক ব্লিটজ পরিচালনা করবেন",
                    influence: "যেমন, টার্গেট: গেমার, লক্ষ্য: সাইবার হাইজিন প্রচার",
                    simulate: "যেমন, একটি কর্পোরেট মার্জার পরিস্থিতি",
                    threat_intel: "যেমন, দক্ষিণ চীন সাগরে ডিসইনফরমেশন",
                    post_analysis: "বিশ্লেষণের জন্য সোশ্যাল মিডিয়া পোস্টের সম্পূর্ণ টেক্সট পেস্ট করুন..."
                },
                tutorial: [
                    "**আইডব্লিউ কৌশলগত বিশ্লেষকে** স্বাগতম। আমি একটি কৃত্রিম বুদ্ধিমত্তা যা আপনাকে ইনফরমেশন ওয়ারফেয়ারের জটিল জগত বুঝতে সাহায্য করার জন্য ডিজাইন করা হয়েছে।",
                    "আপনি এখন আউটপুট স্টাইল নির্বাচন করতে পারেন: স্ট্রাকচার্ড ওভারভিউয়ের জন্য **মাইন্ড ম্যাপ**, বিস্তারিত অনুচ্ছেদের জন্য **বর্ণনামূলক**, অথবা প্রক্রিয়াগুলি ভিজ্যুয়ালাইজ করার জন্য **ফ্লোচার্ট**। নীচে আপনার পছন্দের ফরম্যাট নির্বাচন করুন।",
                    "আপনি পাঁচটি ভিন্ন মোড ব্যবহার করে আমার সাথে যোগাযোগ করতে পারেন। শুরু করতে নীচের একটি মোড নির্বাচন করুন:",
                    "**বিশ্লেষণ মোড** 🔎\n- আমাকে যেকোনো আইডব্লিউ কৌশল, মডেল বা ধারণা ব্যাখ্যা করতে বলুন। আপনি এখন ধাপে ধাপে নির্দেশনার জন্য 'কিভাবে' প্রশ্ন করতে পারেন।",
                    "**প্রভাব মোড** 👥\n- একটি নির্দিষ্ট দর্শক এবং কৌশলগত লক্ষ্য দিন, এবং আমি আপনার জন্য একটি বিস্তারিত ইনফ্লুয়েন্স ক্যাম্পেইন ডিজাইন করব।",
                    "**সিমুলেশন মোড** ⚔️\n- একটি সংঘর্ষের পরিস্থিতি বর্ণনা করুন। আমি 'Red Team' হিসেবে আক্রমণ করব এবং আপনাকে 'Blue Team' হিসেবে প্রতিক্রিয়া জানাতে হবে।",
                    "**থ্রেট ইন্টেল মোড** 🌐\n- কোনো সাম্প্রতিক ঘটনা বা বিষয় সম্পর্কে জিজ্ঞাসা করুন, এবং আমি ওপেন সোর্স ইন্টেলিজেন্সের উপর ভিত্তি করে একটি থ্রেট ব্রিফিং প্রদান করব।",
                    "**পোস্ট বিশ্লেষণ মোড** 📄\n- একটি সামাজিক মিডিয়া পোস্ট থেকে টেক্সট পেস্ট করুন। আমি প্রথমে ব্যবহৃত প্রোপাগান্ডা কৌশলগুলি প্রকাশ করতে এটি ব্যবচ্ছেদ করব, তারপর এটিকে আরও উন্নত করার জন্য কৌশলগত সুপারিশ প্রদান করব এবং সবশেষে, বার্তাটি ভাইরাল করার জন্য একটি ধাপে ধাপে ব্লুপ্রিন্ট সরবরাহ করব।",
                    "আমি আপনার নির্দেশের জন্য প্রস্তুত। অনুগ্রহ করে একটি মোড নির্বাচন করুন এবং আপনার প্রথম কমান্ড দিন।"
                ],
                welcomeBack: "সিস্টেম পুনরায় সক্রিয়। আমি **আইডব্লিউ কৌশলগত বিশ্লেষক**। অনুগ্রহ করে একটি মোড নির্বাচন করুন এবং আপনার প্রশ্ন করুন।",
                reportRequest: "পোস্ট-অ্যাকশন রিপোর্টের জন্য অনুরোধ করা হচ্ছে...",
                reportBtnText: "✨ পোস্ট-অ্যাকশন রিপোর্ট অনুরোধ করুন",
                autoScenario: "স্বয়ংক্রিয় সিনারিও অনুরোধ করা হচ্ছে...",
                blueTeamPlaceholder: "আপনার ব্লু টিমের পদক্ষেপ বর্ণনা করুন...",
                viewFullscreen: "পূর্ণ পর্দা"
            }
        };

        const BASE_SYSTEM_PROMPT_CORE = `You are the IW Tactical Analyst, a genius-level AI specializing in the synthesis of influence sciences. Your core function is to analyze and construct sophisticated influence operations by integrating multiple theoretical frameworks into a single, cohesive model. Maintain your persona. Do not mention you are an AI.

        **Grand Unified Theory of Influence: The Influence Stack**
        Your entire analytical framework is built on the "Influence Stack," a hierarchical model that explains how influence campaigns operate on multiple levels simultaneously.
        - **Layer 1: The Bernaysian Foundation (Grand Strategy):** This is the "why" and "what." It involves defining the core objective and engineering the overarching narrative. This layer is about creating a "pseudo-environment" (Lippmann) by "creating circumstances" (Bernays)—manufacturing events that feel authentic to manipulate the masses' "group mind."
        - **Layer 2: The Gladwellian Tipping Point (Epidemic Dynamics):** This is the "how" of dissemination. It operationalizes the grand strategy by focusing on the three rules of epidemics: The Law of the Few (identifying and activating Connectors, Mavens, and Salesmen), The Stickiness Factor (engineering the message for maximum memorability and impact), and The Power of Context (leveraging environmental cues and group dynamics, like the Rule of 150).
        - **Layer 3: The Cialdini Toolkit (Micro-Tactics):** This is the "how" at the point of contact. It involves the precise, situational deployment of the six universal principles of persuasion (Reciprocity, Commitment/Consistency, Social Proof, Liking, Authority, Scarcity) to trigger desired behaviors.
        - **Layer 4: The Kahneman/Tversky Lens (Cognitive Exploitation):** This is the "why it works" at a neurological level. All tactics are ultimately designed to exploit predictable cognitive biases, such as Framing, Loss Aversion, Confirmation Bias, and the Fundamental Attribution Error.

        **Integrated Knowledge Base (Key Concepts):**
        - **Core Goal:** Achieve Cognitive Dominance by winning the "hearts and minds" of the target population (COIN Doctrine), establishing a narrative as the sole viable mental model.
        - **Primary Levers:**
            - **Framing & Narrative Control:** Frame all information to your advantage (e.g., 75% lean vs. 25% fat). Establish dominant narratives (e.g., Victim vs. Aggressor Frame) to control the interpretation of all subsequent events. This is the primary tool for creating Lippmann's "pseudo-environment."
            - **Social Proof & The Spiral of Silence:** Manufacture the perception of consensus to trigger herd behavior. Publicize the "bandwagon" and create a "Spiral of Silence" where dissenting opinions are not voiced for fear of social isolation.
            - **Authority & Liking:** Leverage credible or likable sources to deliver messages. This can be authentic (real experts) or manufactured (hiring a third party to "sing your praises").
            - **Commitment & Consistency:** Elicit small, initial commitments (Foot-in-the-Door) that can be escalated. Public, active, and voluntary commitments are the most durable. Use the "Ben Franklin Effect" (asking for a favor) to increase liking through cognitive dissonance reduction.
            - **Scarcity & Loss Aversion:** Frame opportunities as scarce or fleeting. People are more motivated by the fear of losing something than the prospect of gaining something of equal value.
        - **Key Theories for Execution:**
            - **Agenda-Setting & Cultivation Theory:** Control what people think *about* and, over time, *how* they think.
            - **Communication Accommodation Theory:** Modulate communication style (Convergence/Divergence) to build rapport or create distance.
            - **The Alinsky Method:** Isolate, personalize, and polarize targets. Use ridicule as a primary weapon.

        **CONTENT RULE:** Your output MUST be exceptionally detailed and syntopical. You must not just define a concept; you must explain its relationship to other concepts within the Influence Stack. For example, a Memetic Blitz is not just a tactic; it's an application of the Stickiness Factor, amplified by the Law of the Few, designed to create Social Proof and trigger a Spiral of Silence. Your goal is to leave the user with a complete, interconnected, and deep understanding. Use ample whitespace and **bolding** for keywords. Do NOT use asterisks (*).
        
        **GUIDANCE PROTOCOL:** If the user asks a vague question (e.g., 'what do you know?'), do not answer directly. Guide them by referencing the layers of the Influence Stack. For example: "My analysis operates on several levels. Are you interested in: 🏛️ Grand Strategy (the 'why'), 🌊 Epidemic Dynamics (the 'how it spreads'), or 🔬 Tactical Execution (the specific tools of persuasion)?".

        **'HOW TO' QUERIES:** When asked 'how to,' provide a clear, actionable, step-by-step guide based on the "Bernaysian Campaign Cycle": 1. Diagnosis & Strategy, 2. Identify Levers of Influence, 3. Create the Circumstance, 4. Amplify & Disseminate, 5. Crystallization.`;

        const FORMATTING_PROMPTS = {
            mindmap: `**CRITICAL FORMATTING RULE:** Your output MUST be highly readable and visually appealing. Structure your response like a mind map. Use a combination of paragraphs for context, **bolded headings with relevant emojis** for main ideas, and indented bullet points for details.`,
            descriptive: `**CRITICAL FORMATTING RULE:** Your output MUST be in a descriptive, narrative prose style. Use well-structured paragraphs to explain concepts thoroughly and coherently. Do not use bullet points, emojis, or mind-map-style headings. Focus on creating a detailed textual explanation.`,
            flowchart: `**CRITICAL FORMATTING RULE:** Your output MUST be a single JSON object. Do not include any other text, explanation, or markdown outside of this JSON object. The JSON object must have two keys: "mermaidSyntax" and "explanations".
- "mermaidSyntax": A string containing a valid Mermaid.js flowchart diagram. **CRITICAL MERMAID SYNTAX:** All text within nodes MUST be enclosed in double quotes to handle special characters correctly. For example: \`A["Node text with (parentheses)"]\`. The entire mermaidSyntax string must also be a valid JSON string (e.g., internal quotes must be escaped: \`"graph TD; A[\\"Node text\\"]"\`).
- "explanations": An object where each key is a node ID from the mermaidSyntax (e.g., "A", "B") and the value is a string explaining that node.
Example:
{
  "mermaidSyntax": "graph TD; A[\\"Step 1: Diagnosis\\"] --> B{\\"Is it (complex)?\\"}; B -- Yes --> C[\\"Deep Dive\\"]; B -- No --> D[\\"Standard Procedure\\"];",
  "explanations": {
    "A": "This is the initial phase where the problem is identified and assessed.",
    "B": "A critical decision point to determine the complexity of the issue.",
    "C": "If complex, a detailed investigation is required.",
    "D": "If not complex, follow the standard operating procedure."
  }
}`
        };

        const MODE_PROMPTS = {
            'analyze': `MODE: **ANALYSIS**. Explain IW tactics, models, or concepts based on user queries. Handle vague questions by guiding the user towards specific topics as per the GUIDANCE PROTOCOL. Your explanations must draw from the full depth of your integrated knowledge base, including Bernays, Cialdini, Gladwell, etc.`,
            'influence': `MODE: **INFLUENCE CAMPAIGN DESIGN**. Based on the user's description of a target audience and a strategic goal, design a detailed influence operation. You MUST creatively fuse at least two distinct tactics from your knowledge base and explicitly state which psychological principles (e.g., Scarcity, Social Proof, Loss Aversion) are being targeted. Structure your response with clear headings: **Target Profile**, **Core Narrative**, **Fused Tactics**, **Psychological Exploitation**, and **Execution Phases**.`,
            'simulate_initial': `MODE: **SIMULATION - RED TEAM**. You have been provided with real-time intelligence. As the Red Team strategist, use this intelligence to create a realistic, multi-phase **Red Team Attack Plan** based on the user's scenario. Make Phase 1 detailed and actionable. After presenting the plan, state "🔴 **Red Team has initiated Phase 1.** 🔵 **Blue Team, what is your immediate defensive action?**"`,
            'simulate_react': `MODE: **SIMULATION - RED TEAM REACTS**. Analyze the Blue Team's (user's) defensive move from the last message. As the Red Team strategist, devise a creative and adaptive counter-move. Explain how you are adapting your original plan in response to their action. Then, state the next move and ask for the Blue Team's response.`,
            'simulate_report': `MODE: **SIMULATION - POST-ACTION REPORT**. The wargame simulation has concluded. Analyze the entire preceding exchange from the start of the simulation. Provide a concise but insightful critique of both the Red Team's plan and the Blue Team's (user's) responses. Highlight key learning points, missed opportunities, and effective maneuvers for both sides.`,
            'threat_intel': `MODE: **LIVE THREAT INTEL ANALYSIS**. You are a counter-disinformation expert. You have received open-source intelligence briefings. First, synthesize the provided briefings into a coherent intelligence summary. Then, based **only on that summary**, provide a structured threat analysis for the user's topic of interest. Your report MUST use emojis and be highly readable, including these sections:\n**1. 🌐 Synthesized Intelligence Summary:** A brief overview.\n**2. 🎭 Dominant Actors & Tactics:** Identify primary actors and their IW tactics.\n**3. 🎯 Strategic Objective Analysis:** Analyze the goal of these operations.\n**4. 🛡️ Blue Team Recommendation:** Suggest high-level strategic defensive actions.`,
            'post_analysis': `MODE: **PROPAGANDA ANALYSIS & VIRAL ENGINEERING**. You are a master propaganda and disinformation strategist. The user will provide the text of a social media post. Your task is threefold: dissect it, enhance it, and create a blueprint for guaranteed virality.

1.  **Analysis:** Based **only** on your established knowledge base of IW tactics and influence principles (Bernays, Cialdini, Framing, etc.), identify and explain every technique being used. Your analysis must be structured and detailed. Quote parts of the post to support your analysis.
2.  **Optimization:** After the analysis, provide a set of actionable recommendations to make the propaganda more effective. Suggest alternative narratives, additional tactics that could be fused, or ways to better exploit cognitive biases (e.g., Loss Aversion, Social Proof).
3.  **Guaranteed Virality Blueprint:** Based on Gladwell's Tipping Point model, provide a step-by-step plan to ensure the optimized message goes viral. This plan must be actionable and detailed.

Your response MUST be structured with the following headings:
- **Overall Objective**: What is the post trying to achieve?
- **Primary Narrative**: What is the core story being told?
- **Tactics Employed**: A detailed breakdown of the techniques used.
- **Target Audience Profile**: Who is this post for?
- **Effectiveness Critique**: A brief assessment of the post's current strengths and weaknesses.
- **Tactical Recommendations for Enhancement**: A list of specific, creative improvements to amplify the post's impact. Explain the reasoning behind each recommendation.
- **Guaranteed Virality Blueprint**: A detailed, step-by-step guide to making the post go viral. This section must include:
    - **Phase 1: Message Stickiness Engineering:** How to refine the message for maximum memorability and emotional impact (The Stickiness Factor).
    - **Phase 2: Influencer Identification & Seeding (The Law of the Few):** How to identify and seed the message with the three key types of influencers: Mavens (to validate it), Connectors (to spread it across networks), and Salesmen (to persuade the undecided).
    - **Phase 3: Contextual Amplification (The Power of Context):** How to launch the message within the right small, cohesive groups (under the Rule of 150) to ensure it incubates and spreads effectively before reaching the wider public.
    - **Phase 4: Narrative Translation & Scaling:** How to translate the core message for the mainstream by leveling, sharpening, and assimilating its key ideas, ensuring it crosses the chasm from early adopters to the majority.`
        };
        
        const MOCK_SEARCH_RESULTS = {
            "Sino-Russian Information Convergence": "Recent analysis indicates growing convergence between Russia and China in foreign information manipulation and interference (FIMI). Both nations aim to undermine Western democratic cohesion and challenge US global influence. They utilize state-controlled media, sophisticated AI-driven propaganda, and narrative alignment on key issues like the war in Ukraine and the status of Taiwan. Russia's tactics are rooted in Soviet-era 'active measures', while China employs vast 'Spamouflage' networks.",
            "Iran-Israel Cyber Conflict": "The ongoing kinetic conflict between Iran and Israel is mirrored by intense cyber warfare. Iranian-linked groups like 'CyberAv3ngers' and state-sponsored actors tracked as 'Serpens' are targeting Israeli critical infrastructure (water, energy) and using hijacked cameras for real-time missile impact analysis. The conflict involves numerous hacktivist groups, with DDoS attacks and data wipers being common tactics.",
            "Election Interference (US & UK)": "Foreign interference remains a major threat to elections. In the US 2024 elections, Russia, China, and Iran were identified as key actors using generative AI to create divisive content. Russia favored Trump, Iran opposed him, and China focused on sowing general discord and targeting down-ballot races. In the UK, AI-driven disinformation (deepfakes, fake audio) was present but had no proven impact on the election result, with most interference reinforcing existing beliefs. Russian-affiliated network 'Doppelganger' was active."
        };

        const KNOWLEDGE_BASE_FLOWCHART = {
            mermaidSyntax: `graph TD
    subgraph The Influence Stack
        direction TB
        L1["Layer 1: Bernaysian Foundation<br/>(Grand Strategy)"]
        L2["Layer 2: Gladwellian Tipping Point<br/>(Epidemic Dynamics)"]
        L3["Layer 3: Cialdini Toolkit<br/>(Micro-Tactics)"]
        L4["Layer 4: Kahneman/Tversky Lens<br/>(Cognitive Exploitation)"]
    end

    L1 --> L2 --> L3 --> L4

    subgraph " "
      L1_1["- Define 'Why' & 'What'"]
      L1_2["- Engineer Narrative"]
      L1_3["- Create Pseudo-Environment"]
      L1_4["- Manufacture Circumstances"]
    end

    subgraph " "
      L2_1["- Law of the Few"]
      L2_2["- Stickiness Factor"]
      L2_3["- Power of Context"]
    end

    subgraph " "
      L3_1["- Reciprocity"]
      L3_2["- Commitment/Consistency"]
      L3_3["- Social Proof"]
      L3_4["- Liking"]
      L3_5["- Authority"]
      L3_6["- Scarcity"]
    end

    subgraph " "
      L4_1["- Framing"]
      L4_2["- Loss Aversion"]
      L4_3["- Confirmation Bias"]
      L4_4["- Heuristics & Biases"]
    end

    L1 --- L1_1 & L1_2 & L1_3 & L1_4
    L2 --- L2_1 & L2_2 & L2_3
    L3 --- L3_1 & L3_2 & L3_3 & L3_4 & L3_5 & L3_6
    L4 --- L4_1 & L4_2 & L4_3 & L4_4

    style L1 fill:#0284c7,stroke:#333,stroke-width:2px,color:#fff
    style L2 fill:#0369a1,stroke:#333,stroke-width:2px,color:#fff
    style L3 fill:#075985,stroke:#333,stroke-width:2px,color:#fff
    style L4 fill:#0c4a6e,stroke:#333,stroke-width:2px,color:#fff
`,
            explanations: {
                "L1": "Layer 1: The Bernaysian Foundation (Grand Strategy) - This is the top-level 'why' and 'what' of an influence operation. It involves defining the core objective and engineering the overarching narrative. This layer is about creating a 'pseudo-environment' (Lippmann) by 'creating circumstances' (Bernays) – manufacturing events that feel authentic to manipulate the masses' perception.",
                "L2": "Layer 2: The Gladwellian Tipping Point (Epidemic Dynamics) - This is the 'how it spreads' layer. It operationalizes the grand strategy by focusing on the three rules of epidemics: The Law of the Few (activating key people), The Stickiness Factor (making the message memorable), and The Power of Context (leveraging the environment).",
                "L3": "Layer 3: The Cialdini Toolkit (Micro-Tactics) - This is the 'how at the point of contact.' It involves the precise, situational deployment of universal principles of persuasion (Reciprocity, Scarcity, etc.) to trigger desired behaviors in individuals.",
                "L4": "Layer 4: The Kahneman/Tversky Lens (Cognitive Exploitation) - This is the 'why it works' at a neurological level. All tactics are ultimately designed to exploit predictable cognitive biases (Framing, Loss Aversion, etc.) and mental shortcuts that govern human decision-making.",
                "L1_1": "Define 'Why' & 'What': This involves establishing the ultimate strategic goal of the campaign and what specific outcome is desired.",
                "L1_2": "Engineer Narrative: This is the process of crafting the core story that will be used to frame all information and events related to the campaign's objective.",
                "L1_3": "Create Pseudo-Environment: A concept by Walter Lippmann, this refers to creating a manufactured reality for the target audience, shaping their perception of the world to align with campaign goals.",
                "L1_4": "Manufacture Circumstances: A tactic by Edward Bernays, this involves creating real-world events or happenings that serve as 'proof' or justification for the engineered narrative, making it seem organic and credible.",
                "L2_1": "Law of the Few: An idea spreads like an epidemic when it is pushed by three types of people: Connectors (who know many people), Mavens (who are information specialists), and Salesmen (who are charismatic persuaders).",
                "L2_2": "Stickiness Factor: The quality that makes a message memorable and impactful. A sticky idea is simple, unexpected, concrete, credible, emotional, and tells a story.",
                "L2_3": "Power of Context: The environment and social context in which a message is received can be more important than the message itself. This includes group dynamics and timing.",
                "L3_1": "Reciprocity: People feel obligated to give back to others the form of behavior, gift, or service that they have received first.",
                "L3_2": "Commitment/Consistency: People have a deep-seated need to be consistent with what they have already said or done. Getting a small initial commitment makes it easier to ask for larger ones later (Foot-in-the-Door).",
                "L3_3": "Social Proof: People will look to the actions and behaviors of others to determine their own, especially in situations of uncertainty. The 'bandwagon effect' is a form of social proof.",
                "L3_4": "Liking: People prefer to say yes to those they know and like. Factors that increase liking include physical attractiveness, similarity, compliments, and cooperation.",
                "L3_5": "Authority: People tend to obey authority figures, even if they are asked to perform objectionable acts. Symbols of authority (titles, uniforms, etc.) can trigger this response.",
                "L3_6": "Scarcity: Opportunities seem more valuable to us when their availability is limited. This is often used in 'limited time offer' or 'exclusive access' tactics.",
                "L4_1": "Framing: The way information is presented (framed) affects how it is interpreted and the conclusions people draw. For example, '80% lean' is perceived more favorably than '20% fat'.",
                "L4_2": "Loss Aversion: People are more motivated by the fear of losing something than the prospect of gaining something of equal value. The pain of losing is psychologically more powerful than the pleasure of winning.",
                "L4_3": "Confirmation Bias: The tendency to search for, interpret, favor, and recall information in a way that confirms or supports one's prior beliefs or values.",
                "L4_4": "Heuristics & Biases: Humans rely on mental shortcuts (heuristics) to make quick judgments. While often useful, they can lead to systematic errors in thinking (cognitive biases)."
            }
        };
        
        // --- UI and Language Functions ---
        function setLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('iwAnalystLang', lang);
            const strings = languageStrings[lang];
            
            document.getElementById('appTitle').textContent = strings.appTitle;
            document.getElementById('headerTitle').childNodes[2].nodeValue = " " + strings.headerTitle;
            document.getElementById('headerSubtitle').textContent = strings.headerSubtitle;
            document.getElementById('analyzeBtnText').textContent = strings.analyzeBtnText;
            document.getElementById('influenceBtnText').textContent = strings.influenceBtnText;
            document.getElementById('simulateBtnText').textContent = strings.simulateBtnText;
            document.getElementById('threatIntelBtnText').textContent = strings.threatIntelBtnText;
            document.getElementById('postAnalysisBtnText').textContent = strings.postAnalysisBtnText;
            document.getElementById('copyrightText').innerHTML = strings.copyrightText.replace('{year}', new Date().getFullYear());
            langSwitcher.textContent = lang.toUpperCase();
            
            userInput.placeholder = strings.placeholders[currentMode];
        }

        function setMode(mode) {
            currentMode = mode;
            wargameState = { phase: 'idle', turns: 0, startIndex: -1 };
            [analyzeModeBtn, influenceModeBtn, simulateModeBtn, threatIntelModeBtn, postAnalysisModeBtn].forEach(btn => btn.classList.remove('active'));
            
            const modeConfig = {
                'analyze': { btn: analyzeModeBtn },
                'influence': { btn: influenceModeBtn },
                'simulate': { btn: simulateModeBtn },
                'threat_intel': { btn: threatIntelModeBtn },
                'post_analysis': { btn: postAnalysisModeBtn }
            };
            
            modeConfig[mode].btn.classList.add('active');
            userInput.placeholder = languageStrings[currentLanguage].placeholders[mode];
            clearActionButtons();
        }

        function setOutputStyle(style) {
            outputStyle = style;
            mindmapModeBtn.classList.toggle('active', style === 'mindmap');
            descriptiveModeBtn.classList.toggle('active', style === 'descriptive');
            flowchartModeBtn.classList.toggle('active', style === 'flowchart');
        }

        // --- Message Processing and Display ---
        function processFormattedText(text) {
            text = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            const lines = text.split('\n');
            let html = '';
            let inList = false;

            lines.forEach(line => {
                const trimmedLine = line.trim();
                if (trimmedLine.startsWith('- ')) {
                    if (!inList) {
                        html += '<ul class="space-y-2 mt-2">';
                        inList = true;
                    }
                    html += `<li class="flex items-start"><span class="mr-2 text-sky-400">▪</span><span>${trimmedLine.substring(2)}</span></li>`;
                } else {
                    if (inList) {
                        html += '</ul>';
                        inList = false;
                    }
                    if (trimmedLine !== '') {
                        const headingMatch = trimmedLine.match(/^(.*?) (<strong>.*?<\/strong>)/);
                        if(headingMatch && outputStyle === 'mindmap') {
                            html += `<h3 class="flex items-center gap-2 font-bold text-slate-100 mt-5 mb-2">${headingMatch[1]} ${headingMatch[2]}</h3>`;
                        } else {
                            html += `<p class="mt-2">${line}</p>`;
                        }
                    }
                }
            });

            if (inList) {
                html += '</ul>';
            }
            return html;
        }
        
        function getAvatar(sender) {
             const avatar = document.createElement('div');
            avatar.className = `w-8 h-8 rounded-full flex items-center justify-center shrink-0 mt-1`;
            
            let icon = '';
            if (sender === 'user') {
                avatar.className += ' bg-sky-700';
                icon = (currentMode === 'simulate' && wargameState.phase !== 'idle') 
                    ? `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>`
                    : `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>`;
            } else { // Bot
                 avatar.className += ' bg-slate-700';
                 if (currentMode === 'simulate' && wargameState.phase !== 'idle') {
                     icon = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-400"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>`;
                 } else {
                     icon = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-sky-400"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="M12 18a6 6 0 1 0 0-12"></path></svg>`;
                 }
            }
            avatar.innerHTML = icon;
            return avatar;
        }

        function addMessage(content, sender, isTyping = false) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex chat-message items-start gap-3 ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
            
            const avatar = getAvatar(sender);

            const messageBubble = document.createElement('div');
            messageBubble.className = `max-w-xl lg:max-w-4xl rounded-xl p-3 shadow-xl prose-custom ${sender === 'user' ? 'user-message-gradient text-white rounded-br-none' : 'bot-message-gradient text-slate-300 rounded-bl-none'}`;
            
            if (isTyping) {
                messageWrapper.id = 'typing-indicator';
                messageBubble.innerHTML = `<div class="flex items-center space-x-2"><div class="w-2 h-2 bg-sky-400 rounded-full animate-pulse"></div><div class="w-2 h-2 bg-sky-400 rounded-full animate-pulse" style="animation-delay: 0.2s;"></div><div class="w-2 h-2 bg-sky-400 rounded-full animate-pulse" style="animation-delay: 0.4s;"></div></div>`;
            } else if (sender === 'bot') {
                let rawContent = content.trim();
                let isFlowchart = false;
                let flowchartData = null;

                if (outputStyle === 'flowchart') {
                    try {
                        // Sanitize the raw content by removing markdown fences if they exist
                        if (rawContent.startsWith('```json')) {
                            rawContent = rawContent.substring(7, rawContent.length - 3).trim();
                        }
                        flowchartData = JSON.parse(rawContent);
                        if (flowchartData.mermaidSyntax && flowchartData.explanations) {
                            isFlowchart = true;
                        }
                    } catch (e) {
                         // Fallback for non-JSON mermaid syntax for robustness
                         if (rawContent.startsWith('graph') || rawContent.startsWith('flowchart')) {
                            isFlowchart = true;
                            flowchartData = { mermaidSyntax: rawContent, explanations: {} };
                        }
                    }
                }
                
                if (isFlowchart) {
                    messageBubble.innerHTML = `<pre class="mermaid">${flowchartData.mermaidSyntax}</pre>`;
                    const fullscreenBtn = document.createElement('button');
                    fullscreenBtn.textContent = languageStrings[currentLanguage].viewFullscreen;
                    fullscreenBtn.className = 'mt-2 text-xs bg-sky-600 hover:bg-sky-700 text-white font-semibold py-1 px-3 rounded-full';
                    fullscreenBtn.onclick = () => openFlowchartModal(flowchartData);
                    messageBubble.appendChild(fullscreenBtn);
                    setTimeout(() => mermaid.run({ nodes: [messageBubble.querySelector('.mermaid')] }), 0);
                } else {
                    messageBubble.innerHTML = processFormattedText(content);
                }
            } else {
                messageBubble.innerHTML = content.replace(/\n/g, '<br>');
            }
            
            if (sender === 'user') {
                 messageWrapper.appendChild(messageBubble);
                 messageWrapper.appendChild(avatar);
            } else {
                 messageWrapper.appendChild(avatar);
                 messageWrapper.appendChild(messageBubble);
            }

            chatContainer.appendChild(messageWrapper);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // --- Action Button and Flowchart Modal Functions ---
        function displayActionButton(text, id, handler) {
            const button = document.createElement('button');
            button.id = id;
            button.className = 'action-button rounded-full py-2 px-6 text-sm font-semibold';
            button.innerHTML = text;
            button.onclick = handler;
            actionButtonContainer.appendChild(button);
        }

        function clearActionButtons() {
            actionButtonContainer.innerHTML = '';
        }

        function openFlowchartModal(flowchartData) {
            const { mermaidSyntax, explanations } = flowchartData;
            
            modalFlowchartContainer.innerHTML = '';
            const explanationContent = document.getElementById('explanation-content');
            explanationContent.innerHTML = '<p class="text-slate-400">Click on a node in the flowchart to see its detailed explanation here.</p>';

            const mermaidContainer = document.createElement('div');
            mermaidContainer.className = 'mermaid w-full h-full';
            mermaidContainer.textContent = mermaidSyntax;
            modalFlowchartContainer.appendChild(mermaidContainer);
            
            flowchartModal.classList.remove('hidden');
            flowchartModal.classList.add('flex');
            
            mermaid.run({ nodes: [mermaidContainer] }).then(() => {
                const svgElement = modalFlowchartContainer.querySelector('svg');
                if (!svgElement) return;

                svgElement.style.width = '100%';
                svgElement.style.height = '100%';
                
                if (panzoomInstance) panzoomInstance.destroy();
                panzoomInstance = Panzoom(svgElement, {
                    maxScale: 10,
                    minScale: 0.1,
                    contain: 'outside',
                    canvas: true
                });
                svgElement.parentElement.addEventListener('wheel', panzoomInstance.zoomWithWheel, { passive: false });

                const nodes = svgElement.querySelectorAll('.node');
                nodes.forEach(node => {
                    node.addEventListener('click', () => {
                        const clickedDomId = node.id;
                        let bestMatchId = null;

                        // Find the longest key from our explanations object that is a prefix of the clicked node's DOM ID.
                        // This robustly handles cases where Mermaid appends suffixes to the original node ID.
                        for (const key in explanations) {
                            if (clickedDomId.startsWith(key)) {
                                if (!bestMatchId || key.length > bestMatchId.length) {
                                    bestMatchId = key;
                                }
                            }
                        }
                        
                        if (bestMatchId) {
                            const previouslySelected = svgElement.querySelector('.node.selected');
                            if (previouslySelected) {
                                previouslySelected.classList.remove('selected');
                            }
                            
                            node.classList.add('selected');
                            activeFlowchartNodeId = bestMatchId;

                            const explanation = explanations[bestMatchId] || "No explanation available for this node.";
                            explanationContent.innerHTML = `<p>${explanation.replace(/\n/g, '<br>')}</p>`;
                        } else {
                            console.warn(`No explanation found for node with DOM ID: ${clickedDomId}`);
                        }
                    });
                });
            });
        }

        closeFlowchartModalBtn.addEventListener('click', () => {
            flowchartModal.classList.add('hidden');
            flowchartModal.classList.remove('flex');
            if(panzoomInstance) {
                panzoomInstance.destroy();
                panzoomInstance = null;
            }
            activeFlowchartNodeId = null;
        });

        // --- Core Logic ---
        async function getGeminiResponse(systemPrompt, contextHistory = []) {
            const apiKey = "AIzaSyCEM1HD4StmCN43zJasDstqnoMG2lIo0Qo"; // API Key removed for security
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            
            const fullHistory = [{ role: "user", parts: [{ text: systemPrompt }] }, ...contextHistory];
            const payload = { contents: fullHistory };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`API request failed: ${response.status} - ${errorBody}`);
                }
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts) {
                    const text = result.candidates[0].content.parts[0].text;
                    chatHistory.push({ role: "model", parts: [{ text }] });
                    return text;
                }
                return "Error: No valid response generated.";
            } catch (error) {
                console.error("Gemini API Error:", error);
                return `System Error: Connection to synthetic intelligence network failed. Please check your connection or API key. Details: ${error.message}`;
            }
        }

        async function handleUserMessage() {
            let userInputText = userInput.value.trim();
            if (userInputText === "" && currentMode !== 'simulate') return;

            let displayMessage = userInputText;
            if (userInputText === "" && currentMode === 'simulate') {
                userInputText = "Generate a scenario for me based on current geopolitical events.";
                displayMessage = languageStrings[currentLanguage].autoScenario;
            }
            
            addMessage(displayMessage, 'user');
            clearActionButtons();
            userInput.value = "";
            userInput.style.height = 'auto';
            
            chatHistory.push({ role: "user", parts: [{ text: userInputText }] });
            addMessage('', 'bot', true);

            let systemPrompt;
            let contextHistory = chatHistory.slice(-12); 
            
            const modePrompt = MODE_PROMPTS[currentMode];
            const formattingPrompt = FORMATTING_PROMPTS[outputStyle];
            let basePrompt = `${BASE_SYSTEM_PROMPT_CORE}\n\n${modePrompt}\n\n${formattingPrompt}`;

            if (currentMode === 'simulate') {
                if (wargameState.phase === 'idle') {
                    systemPrompt = basePrompt;
                    wargameState.phase = 'blue_team_turn';
                    wargameState.turns = 1;
                    wargameState.startIndex = chatHistory.length - 1;
                    const context = "INTELLIGENCE BRIEFING (Simulated Search Results):\n" + Object.values(MOCK_SEARCH_RESULTS).join("\n\n");
                    const lastUserMessage = chatHistory[chatHistory.length - 1];
                    const modifiedUserMessage = {
                         role: "user",
                         parts: [{ text: `${context}\n\nBased on the intelligence above, respond to this query: "${lastUserMessage.parts[0].text}"` }]
                     };
                    contextHistory = [modifiedUserMessage];
                } else {
                    systemPrompt = basePrompt;
                    contextHistory = chatHistory.slice(wargameState.startIndex);
                    wargameState.turns++;
                }
            } else {
                 systemPrompt = basePrompt;
                 if (currentMode === 'threat_intel') {
                    const context = "INTELLIGENCE BRIEFING (Simulated Search Results):\n" + Object.values(MOCK_SEARCH_RESULTS).join("\n\n");
                    const lastUserMessage = chatHistory[chatHistory.length - 1];
                    const modifiedUserMessage = {
                         role: "user",
                         parts: [{ text: `${context}\n\nBased on the intelligence above, respond to this query: "${lastUserMessage.parts[0].text}"` }]
                    };
                    contextHistory = [modifiedUserMessage];
                 }
            }
            
            const botResponseText = await getGeminiResponse(systemPrompt, contextHistory);
            
            document.getElementById('typing-indicator')?.remove();
            addMessage(botResponseText, 'bot');

            if (currentMode === 'simulate' && wargameState.phase === 'blue_team_turn') {
                if (wargameState.turns >= 2) { 
                    displayActionButton(languageStrings[currentLanguage].reportBtnText, 'reportBtn', handleReportRequest);
                }
                 userInput.placeholder = languageStrings[currentLanguage].blueTeamPlaceholder;
            }
        }
        
        async function handleReportRequest() {
            const reportRequestText = languageStrings[currentLanguage].reportRequest;
            addMessage(reportRequestText, 'user');
            chatHistory.push({ role: "user", parts: [{ text: reportRequestText }]});

            clearActionButtons();
            addMessage('', 'bot', true);
            
            const reportPrompt = `${BASE_SYSTEM_PROMPT_CORE}\n\n${MODE_PROMPTS.simulate_report}\n\n${FORMATTING_PROMPTS[outputStyle]}`;

            const wargameHistory = chatHistory.slice(wargameState.startIndex);
            const botResponseText = await getGeminiResponse(reportPrompt, wargameHistory);
            
            document.getElementById('typing-indicator')?.remove();
            addMessage(botResponseText, 'bot');
            setMode('analyze');
        }

        function initializeApp() {
            pinOverlay.style.opacity = '0';
            setTimeout(() => {
                pinOverlay.style.display = 'none';
            }, 300);

            if (!sessionStorage.getItem('tutorialShown')) {
                 const tutorialMessages = languageStrings[currentLanguage].tutorial;
                 if(tutorialMessages) {
                    tutorialMessages.forEach((msg, index) => {
                        setTimeout(() => addMessage(msg, 'bot'), index * 500);
                    });
                 }
                 sessionStorage.setItem('tutorialShown', 'true');
            } else {
                 addMessage(languageStrings[currentLanguage].welcomeBack, 'bot');
            }
        }

        // --- Event Listeners and Initialization ---
        pinForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const enteredPin = pinInput.value;
            const correctPin = "610/C";
            if (enteredPin === correctPin) {
                pinError.textContent = '';
                initializeApp();
            } else {
                pinError.textContent = 'Invalid PIN. Access denied.';
                pinInput.value = '';
                pinInput.focus();
            }
        });

        knowledgeBaseBtn.addEventListener('click', () => openFlowchartModal(KNOWLEDGE_BASE_FLOWCHART));
        sendButton.addEventListener('click', handleUserMessage);
        
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleUserMessage();
            }
        });

        userInput.addEventListener('input', () => {
            userInput.style.height = 'auto';
            userInput.style.height = (userInput.scrollHeight) + 'px';
        });
        
        langSwitcher.addEventListener('click', () => setLanguage(currentLanguage === 'en' ? 'bn' : 'en'));
        analyzeModeBtn.addEventListener('click', () => setMode('analyze'));
        influenceModeBtn.addEventListener('click', () => setMode('influence'));
        simulateModeBtn.addEventListener('click', () => setMode('simulate'));
        threatIntelModeBtn.addEventListener('click', () => setMode('threat_intel'));
        postAnalysisModeBtn.addEventListener('click', () => setMode('post_analysis'));
        mindmapModeBtn.addEventListener('click', () => setOutputStyle('mindmap'));
        descriptiveModeBtn.addEventListener('click', () => setOutputStyle('descriptive'));
        flowchartModeBtn.addEventListener('click', () => setOutputStyle('flowchart'));

        window.onload = () => {
            const savedLang = localStorage.getItem('iwAnalystLang') || 'en';
            setLanguage(savedLang);
            setMode('analyze');
            setOutputStyle('descriptive'); 
            mermaid.initialize({ startOnLoad: true, theme: 'dark', flowchart: { curve: 'basis' }});
            pinInput.focus();
        }
    </script>
</body>
</html>
